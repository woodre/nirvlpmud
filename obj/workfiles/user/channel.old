/*
// channel.c
//
// This object is central to the channel system being set up
// on Nirvana.
// The system is developed to look like the channel system on TMI,
// though the code (being non-native mode) will be different.
// Developed by Shadowhawk the NUISANCE
*/

#pragma strict_types
#pragma save_types
#define FREE_CHANNELS ({ "gossip", "equip", "shout", "risque" })

int list_users(string channel);
int valid_channel(string channel);

string *channel_names;

int
add_channel(string new_chan) {
  if (!valid_channel(new_chan)) {
    write("The channel " + new_chan + " is invalid.\n");
    return 1;
  }
  if (member_array(new_chan, channel_names) != -1) {
    write("You are already on that channel.\n");
    return 1;
  }
  channel_names += ({ new_chan });
  add_action("broadcast", new_chan);
  return 1;
}

int
remove_channel(string channel) {
  int index;

  if ((index = member_array(channel, channel_names)) == -1) {
    write("You are not on that channel.\n");
    return 1;
  }
  channel_names -= ({ channel_names[index] });
  remove_action(channel);
  return 1;
}

int
broadcast(string msg) {
  string channel;
  object *people;
  int index;

  channel = query_verb();
  if (msg == "list")
    return list_users(channel);
  if (!this_player()->setup_broadcast())
    return 1;
  if (msg[0] == ':') /* Emoting broadcast */
    msg = "(" + channel + ") " + this_object()->query_name() + " " + 
      msg[1..strlen(msg)] + "\n";
  else
    msg = this_player()->query_name() + " " + channel + "s: " + msg + "\n";
  people = users();
  for (index = 0; index < sizeof(people); index++)
    if (people[index]->on_channel(channel) || channel == "announce")
      tell_object(people[index], msg);
  return 1;
}

int
list_users(string channel) {
  int index;
  object *people;
  string str;

  str = "On channel " + channel + ": ";
  people = users();
  for (index = sizeof(people) - 1; index >= 0; index--) 
    if (people[index]->on_channel(channel) || channel == "announce")
      if (!people[index]->query_invis())
	str += people[index]->query_name() + (index ? ", " : " ");
  write(format(str));
  return 1;
}

int
valid_channel(string channel) {
  if (member_array(channel, FREE_CHANNELS) != -1)
    return 1;
  if (channel == "wiz" || channel == "announce")
    /* Only wizards have access to this channel. */
    return (this_object()->query_level() > 20);
  return 0;
}

int
on_channel(string channel) {
  return (member_array(channel, channel_names) != -1);
}

int
list_channels() {
  int index;
  
  index = sizeof(channel_names);
  if (index == 0)
    write("You aren't on any channels.\n");
  else if (index == 1)
    write("You are on channel: " + channel_names[0] + "\n");
  else if (index == 2)
    write("You are on channels: " + channel_names[0] +
	  " and " + channel_names[1] + "\n");
  else {
    write("You are on channels: ");
    for (index = sizeof(channel_names) - 1; index > 0; index--)
      write(channel_names[index] + ", ");
    write("and " + channel_names[0] + "\n");
  }
  return 1;
}

void
init_channels() {
  int index;

  for (index = 0; index < sizeof(channel_names); index++)
    add_action("broadcast", channel_names[index]);
}
